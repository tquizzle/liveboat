{"id":"Y2iXpRRkNSnxtBLmMYZFrnqj4bsEj1XB8agfaptmWsYpB","title":"vnotes","displayTitle":"Dev - vladkens","url":"https://vnotes.pages.dev/atom.xml","feedLink":"https://vnotes.pages.dev/","items":[{"title":"Creating OG Images for Static Pages with Rust","url":"https://vnotes.pages.dev/og-image-generator/","date":1732924800,"author":"Unknown","unread":true,"desc":"","content":"<p>OGP (<a rel=\"noopener\" target=\"_blank\" href=\"https://ogp.me/\">Open Graph Protocol</a>) is an HTML meta-tags specification for websites to make links look nice in third-party services such as Facebook, X, LinkedIn or chat apps. OGP also allows to specify a link to page thumbnail that will be shown as preview when link shared, which can increase clickability.</p>\n<p>Some blog engines have built-in functions for this. I use <a rel=\"noopener\" target=\"_blank\" href=\"https://getzola.org/\">Zola</a> (static page generator) to create pages for this blog. Unfortunately, Zola does not have an ability to generate OG images. This can be achieved with external tools or scripts during the build process. Another approach to use edge functions (such as <a rel=\"noopener\" target=\"_blank\" href=\"https://vercel.com/docs/functions/og-image-generation\">vercel/og</a>) to generate thumbnails on the fly. However, this approach relies on a specific service provider, which I want to avoid.</p>\n<p>I thought, why not use OG image generation as a service? I searched around and found <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/sagarhani/og-image-generator\">og-image-generator</a> by sagarhani.</p>\n<p>The functionality of <code>og-image-generator</code> worked well for me, and I used it for this blog for some time. However, the project seems abandoned, and I'm unsure how the author feels about additional load on their service. I decided it shouldn't be too hard to create a similar service myself — a single endpoint for generating images with search params. Moreover, when I looked into the source code of <code>og-image-generator</code>, I noticed that it launches Chrome to render an image from HTML, which felt like significant overhead to me.</p>\n<h2 id=\"coding\"><a class=\"zola-anchor\" href=\"#coding\" aria-label=\"Anchor link for: coding\">Coding</a></h2>\n<p>I need an endpoint that accepts: article title, URL/domain, author name and avatar via search parameters. Lately, I've been using Rust for most of my pet projects, so I decided to build this service with Rust as well. I added a route in <code>axum</code> and implemented a handler that generates SVG images, using some basic math to calculate the positioning of elements. The size of the OG image is predefined as <code>1200x630</code>, following the specefication. SVG allows the use of a <code>&lt;style&gt;</code> tag, making it easy to customise default font-family.</p>\n<p>The only challenge I encountered was creating a mask for the image. I initially thought SVG might have some syntactic sugar for this, but it essentially works the same way as masks in Photoshop.</p>\n<p>Example of SVG generation (<a rel=\"noopener\" target=\"_blank\" href=\"https://maud.lambda.xyz/\"><code>maud</code></a> is an HTML template engine on Rust macros):</p>\n<pre data-lang=\"rust\" style=\"background-color:#2b303b;color:#c0c5ce;\" class=\"language-rust \"><code class=\"language-rust\" data-lang=\"rust\"><span style=\"color:#b48ead;\">use </span><span>maud::{html, Markup};\n</span><span>\n</span><span style=\"color:#b48ead;\">fn </span><span style=\"color:#8fa1b3;\">render_svg</span><span>(</span><span style=\"color:#bf616a;\">title</span><span>: &amp;</span><span style=\"color:#b48ead;\">str</span><span>, </span><span style=\"color:#bf616a;\">author</span><span>: &amp;</span><span style=\"color:#b48ead;\">str</span><span>, </span><span style=\"color:#bf616a;\">url</span><span>: &amp;</span><span style=\"color:#b48ead;\">str</span><span>, </span><span style=\"color:#bf616a;\">photo</span><span>: &amp;</span><span style=\"color:#b48ead;\">str</span><span>) -&gt; Markup {\n</span><span>  </span><span style=\"color:#b48ead;\">let </span><span>(w, h) = (</span><span style=\"color:#d08770;\">1200</span><span>, </span><span style=\"color:#d08770;\">630</span><span>);\n</span><span>\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> pic_r = </span><span style=\"color:#d08770;\">50</span><span>;\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> pic_y = h - </span><span style=\"color:#d08770;\">128</span><span>;\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> l1y = pic_y - (pic_r - </span><span style=\"color:#d08770;\">10</span><span>) / </span><span style=\"color:#d08770;\">2 </span><span>+ </span><span style=\"color:#d08770;\">48 </span><span>/ </span><span style=\"color:#d08770;\">2 </span><span>- </span><span style=\"color:#d08770;\">6</span><span>;\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> l2y = pic_y - (pic_r - </span><span style=\"color:#d08770;\">10</span><span>) / </span><span style=\"color:#d08770;\">2 </span><span>+ </span><span style=\"color:#d08770;\">32 </span><span>/ </span><span style=\"color:#d08770;\">2 </span><span>+ </span><span style=\"color:#d08770;\">6 </span><span>+ </span><span style=\"color:#d08770;\">32</span><span>;\n</span><span>\n</span><span>  html!(svg xmlns=&quot;</span><span style=\"color:#a3be8c;\">http://www.w3.org/2000/svg</span><span>&quot; viewBox=(format!(&quot;</span><span style=\"color:#a3be8c;\">0 0 </span><span style=\"color:#d08770;\">{} {}</span><span>&quot;, w, h)) width=(w) height=(h) {\n</span><span>    style { (&quot;</span><span style=\"color:#a3be8c;\">text { font-family: &#39;Open Sans&#39;, Arial, sans-serif; }</span><span>&quot; ) }\n</span><span>\n</span><span>    rect x=&quot;</span><span style=\"color:#a3be8c;\">0</span><span>&quot; y=&quot;</span><span style=\"color:#a3be8c;\">0</span><span>&quot; width=(w) height=(h) fill=&quot;</span><span style=\"color:#a3be8c;\">black</span><span>&quot; stroke=&quot;</span><span style=\"color:#a3be8c;\">white</span><span>&quot; stroke-width=&quot;</span><span style=\"color:#a3be8c;\">16</span><span>&quot; {}\n</span><span>    text x=(</span><span style=\"color:#d08770;\">120</span><span>) y=(</span><span style=\"color:#d08770;\">200</span><span>) font-weight=&quot;</span><span style=\"color:#a3be8c;\">700</span><span>&quot; font-size=&quot;</span><span style=\"color:#a3be8c;\">72</span><span>&quot; fill=&quot;</span><span style=\"color:#a3be8c;\">white</span><span>&quot; { (title) }\n</span><span>    text x=(</span><span style=\"color:#d08770;\">200</span><span>) y=(l1y) font-weight=&quot;</span><span style=\"color:#a3be8c;\">700</span><span>&quot; font-size=&quot;</span><span style=\"color:#a3be8c;\">48</span><span>&quot; fill=&quot;</span><span style=\"color:#a3be8c;\">white</span><span>&quot; { (author) }\n</span><span>    text x=(</span><span style=\"color:#d08770;\">200</span><span>) y=(l2y) font-weight=&quot;</span><span style=\"color:#a3be8c;\">400</span><span>&quot; font-size=&quot;</span><span style=\"color:#a3be8c;\">32</span><span>&quot; fill=&quot;</span><span style=\"color:#a3be8c;\">white</span><span>&quot; { (url) }\n</span><span>    (</span><span style=\"color:#96b5b4;\">circle_avatar</span><span>(photo, </span><span style=\"color:#d08770;\">128</span><span>, pic_y, pic_r))\n</span><span>  })\n</span><span>}\n</span><span>\n</span><span style=\"color:#b48ead;\">fn </span><span style=\"color:#8fa1b3;\">circle_avatar</span><span>(</span><span style=\"color:#bf616a;\">url</span><span>: &amp;</span><span style=\"color:#b48ead;\">str</span><span>, </span><span style=\"color:#bf616a;\">cx</span><span>: </span><span style=\"color:#b48ead;\">u32</span><span>, </span><span style=\"color:#bf616a;\">cy</span><span>: </span><span style=\"color:#b48ead;\">u32</span><span>, </span><span style=\"color:#bf616a;\">radius</span><span>: </span><span style=\"color:#b48ead;\">u32</span><span>) -&gt; Markup {\n</span><span>  html!({\n</span><span>    defs {\n</span><span>      clipPath id=&quot;</span><span style=\"color:#a3be8c;\">circle-photo</span><span>&quot; { circle cx=(cx) cy=(cy) r=(radius) {} }\n</span><span>    }\n</span><span>\n</span><span>    g clip-path=&quot;</span><span style=\"color:#a3be8c;\">url(#circle-photo)</span><span>&quot; {\n</span><span>      image href=(url) x=(cx-radius) y=(cy-radius) width=(radius * </span><span style=\"color:#d08770;\">2</span><span>) height=(radius * </span><span style=\"color:#d08770;\">2</span><span>) {}\n</span><span>      circle cx=(cx) cy=(cy) r=(radius) stroke=&quot;</span><span style=\"color:#a3be8c;\">white</span><span>&quot; stroke-width=&quot;</span><span style=\"color:#a3be8c;\">4</span><span>&quot; fill=&quot;</span><span style=\"color:#a3be8c;\">none</span><span>&quot; {}\n</span><span>    }\n</span><span>  })\n</span><span>}\n</span></code></pre>\n<p>And then the SVG image is generated in the Axum handler:</p>\n<pre data-lang=\"rust\" style=\"background-color:#2b303b;color:#c0c5ce;\" class=\"language-rust \"><code class=\"language-rust\" data-lang=\"rust\"><span style=\"color:#b48ead;\">use </span><span>axum::extract::{Query, Request};\n</span><span style=\"color:#b48ead;\">use </span><span>axum::http::{header, StatusCode};\n</span><span style=\"color:#b48ead;\">use </span><span>axum::response::IntoResponse;\n</span><span style=\"color:#b48ead;\">use </span><span>std::collections::HashMap;\n</span><span>\n</span><span>async </span><span style=\"color:#b48ead;\">fn </span><span style=\"color:#8fa1b3;\">svg_handler</span><span>(</span><span style=\"color:#bf616a;\">req</span><span>: Request) -&gt; Res&lt;impl IntoResponse&gt; {\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> qs: Query&lt;HashMap&lt;String, String&gt;&gt; = Query::try_from_uri(req.</span><span style=\"color:#96b5b4;\">uri</span><span>())?;\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> title = qs.</span><span style=\"color:#96b5b4;\">get</span><span>(&quot;</span><span style=\"color:#a3be8c;\">title</span><span>&quot;).</span><span style=\"color:#96b5b4;\">cloned</span><span>().</span><span style=\"color:#96b5b4;\">unwrap_or</span><span>(&quot;</span><span style=\"color:#a3be8c;\">This is default article title</span><span>&quot;.</span><span style=\"color:#96b5b4;\">to_string</span><span>());\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> author = qs.</span><span style=\"color:#96b5b4;\">get</span><span>(&quot;</span><span style=\"color:#a3be8c;\">author</span><span>&quot;).</span><span style=\"color:#96b5b4;\">cloned</span><span>().</span><span style=\"color:#96b5b4;\">unwrap_or</span><span>(&quot;</span><span style=\"color:#a3be8c;\">Author</span><span>&quot;.</span><span style=\"color:#96b5b4;\">to_string</span><span>());\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> url = qs.</span><span style=\"color:#96b5b4;\">get</span><span>(&quot;</span><span style=\"color:#a3be8c;\">url</span><span>&quot;).</span><span style=\"color:#96b5b4;\">cloned</span><span>().</span><span style=\"color:#96b5b4;\">unwrap_or</span><span>(&quot;</span><span style=\"color:#a3be8c;\">https://example.com</span><span>&quot;.</span><span style=\"color:#96b5b4;\">to_string</span><span>());\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> photo = qs.</span><span style=\"color:#96b5b4;\">get</span><span>(&quot;</span><span style=\"color:#a3be8c;\">photo</span><span>&quot;).</span><span style=\"color:#96b5b4;\">cloned</span><span>().</span><span style=\"color:#96b5b4;\">unwrap_or</span><span>(&quot;</span><span style=\"color:#a3be8c;\">https://gravatar.com/avatar/</span><span>&quot;.</span><span style=\"color:#96b5b4;\">to_string</span><span>());\n</span><span>\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> svg = </span><span style=\"color:#96b5b4;\">render_svg</span><span>(&amp;title, &amp;author, &amp;url, &amp;photo);\n</span><span>  Ok((StatusCode::</span><span style=\"color:#d08770;\">OK</span><span>, [(header::</span><span style=\"color:#d08770;\">CONTENT_TYPE</span><span>, &quot;</span><span style=\"color:#a3be8c;\">image/svg+xml</span><span>&quot;)], svg))\n</span><span>}\n</span></code></pre>\n<p>This code will generate the following SVG:</p>\n<p><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 1200 630\"><style>text { font-family: 'Open Sans', Arial, sans-serif; }</style><rect x=\"0\" y=\"0\" width=\"1200\" height=\"630\" fill=\"black\" stroke=\"white\" stroke-width=\"16\"></rect><text x=\"120\" y=\"200\" font-weight=\"700\" font-size=\"72\" fill=\"white\">This is default article title</text><text x=\"200\" y=\"500\" font-weight=\"700\" font-size=\"48\" fill=\"white\">Author</text><text x=\"200\" y=\"536\" font-weight=\"400\" font-size=\"32\" fill=\"white\">https://example.com</text><defs><clipPath id=\"circle-photo\"><circle cx=\"128\" cy=\"502\" r=\"50\"></circle></clipPath></defs><g clip-path=\"url(#circle-photo)\"><image href=\"https://gravatar.com/avatar/\" x=\"78\" y=\"452\" width=\"100\" height=\"100\"></image><circle cx=\"128\" cy=\"502\" r=\"50\" stroke=\"white\" stroke-width=\"4\" fill=\"none\"></circle></g></svg></p>\n<p>The endpoint can accept <code>title</code>, <code>author</code>, <code>url</code> and <code>photo</code> in the search params, and these values will be passed to SVG template. That's pretty much it, I thought, deployed the service to <a href=\"/deploy-fastapi-with-sqlite-on-flyio/\">fly.io</a>, updated the blog links, went to check how new preview looked, and the thumbnail didn't display.</p>\n<p>It turned out that OG images cannot be SVG (which makes sense, because then different mobile clients would need to be able to render it, which is harder then showing prepared image).</p>\n<h2 id=\"svg-to-png\"><a class=\"zola-anchor\" href=\"#svg-to-png\" aria-label=\"Anchor link for: svg-to-png\">SVG to PNG</a></h2>\n<p>It's not a big deal, I thought. A lot things has already been rewritten in Rust, and there's probably a ready to use solution for SVG rendering, especially since I found several popular crates for this. But it turned out to be more complicated than expected. Rendering SVG to PNG is quite a complex task, and the SVG specification is huge, so libs not fully implement the specification. However, I only need basic SVG support. I tried several crates and settled on <code>resvg</code>. I wrote a rendering function:</p>\n<pre data-lang=\"rust\" style=\"background-color:#2b303b;color:#c0c5ce;\" class=\"language-rust \"><code class=\"language-rust\" data-lang=\"rust\"><span style=\"color:#b48ead;\">use </span><span>resvg::{tiny_skia, usvg};\n</span><span>\n</span><span style=\"color:#b48ead;\">fn </span><span style=\"color:#8fa1b3;\">render_png</span><span>(</span><span style=\"color:#bf616a;\">svg</span><span>: &amp;</span><span style=\"color:#b48ead;\">str</span><span>) -&gt; Vec&lt;</span><span style=\"color:#b48ead;\">u8</span><span>&gt; {\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> tree = {\n</span><span>    </span><span style=\"color:#b48ead;\">let mut</span><span> opt = usvg::Options::default();\n</span><span>    opt.</span><span style=\"color:#96b5b4;\">fontdb_mut</span><span>().</span><span style=\"color:#96b5b4;\">load_system_fonts</span><span>();\n</span><span>    usvg::Tree::from_str(svg, &amp;opt).</span><span style=\"color:#96b5b4;\">unwrap</span><span>()\n</span><span>  };\n</span><span>\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> size = tree.</span><span style=\"color:#96b5b4;\">size</span><span>().</span><span style=\"color:#96b5b4;\">to_int_size</span><span>();\n</span><span>  </span><span style=\"color:#b48ead;\">let mut</span><span> pixmap = tiny_skia::Pixmap::new(size.</span><span style=\"color:#96b5b4;\">width</span><span>(), size.</span><span style=\"color:#96b5b4;\">height</span><span>()).</span><span style=\"color:#96b5b4;\">unwrap</span><span>();\n</span><span>  resvg::render(&amp;tree, tiny_skia::Transform::default(), &amp;</span><span style=\"color:#b48ead;\">mut</span><span> pixmap.</span><span style=\"color:#96b5b4;\">as_mut</span><span>());\n</span><span>  pixmap.</span><span style=\"color:#96b5b4;\">encode_png</span><span>().</span><span style=\"color:#96b5b4;\">unwrap</span><span>()\n</span><span>}\n</span></code></pre>\n<p>And updated handlers:</p>\n<pre data-lang=\"rust\" style=\"background-color:#2b303b;color:#c0c5ce;\" class=\"language-rust \"><code class=\"language-rust\" data-lang=\"rust\"><span style=\"color:#65737e;\">// in some reason axum not allow to pass Request as ref – code will not compile, so req.uri() used\n</span><span>async </span><span style=\"color:#b48ead;\">fn </span><span style=\"color:#8fa1b3;\">prepare_svg</span><span>(</span><span style=\"color:#bf616a;\">uri</span><span>: &amp;axum::http::Uri) -&gt; Res&lt;String&gt; {\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> qs: Query&lt;HashMap&lt;String, String&gt;&gt; = Query::try_from_uri(uri)?;\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> title = qs.</span><span style=\"color:#96b5b4;\">get</span><span>(&quot;</span><span style=\"color:#a3be8c;\">title</span><span>&quot;).</span><span style=\"color:#96b5b4;\">cloned</span><span>().</span><span style=\"color:#96b5b4;\">unwrap_or</span><span>(&quot;</span><span style=\"color:#a3be8c;\">This is default article title</span><span>&quot;.</span><span style=\"color:#96b5b4;\">to_string</span><span>());\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> author = qs.</span><span style=\"color:#96b5b4;\">get</span><span>(&quot;</span><span style=\"color:#a3be8c;\">author</span><span>&quot;).</span><span style=\"color:#96b5b4;\">cloned</span><span>().</span><span style=\"color:#96b5b4;\">unwrap_or</span><span>(&quot;</span><span style=\"color:#a3be8c;\">Author</span><span>&quot;.</span><span style=\"color:#96b5b4;\">to_string</span><span>());\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> url = qs.</span><span style=\"color:#96b5b4;\">get</span><span>(&quot;</span><span style=\"color:#a3be8c;\">url</span><span>&quot;).</span><span style=\"color:#96b5b4;\">cloned</span><span>().</span><span style=\"color:#96b5b4;\">unwrap_or</span><span>(&quot;</span><span style=\"color:#a3be8c;\">https://example.com</span><span>&quot;.</span><span style=\"color:#96b5b4;\">to_string</span><span>());\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> photo = qs.</span><span style=\"color:#96b5b4;\">get</span><span>(&quot;</span><span style=\"color:#a3be8c;\">photo</span><span>&quot;).</span><span style=\"color:#96b5b4;\">cloned</span><span>().</span><span style=\"color:#96b5b4;\">unwrap_or</span><span>(&quot;</span><span style=\"color:#a3be8c;\">https://gravatar.com/avatar/</span><span>&quot;.</span><span style=\"color:#96b5b4;\">to_string</span><span>());\n</span><span>  Ok(</span><span style=\"color:#96b5b4;\">render_svg</span><span>(&amp;title, &amp;author, &amp;url, &amp;photo).</span><span style=\"color:#96b5b4;\">into_string</span><span>())\n</span><span>}\n</span><span>\n</span><span>async </span><span style=\"color:#b48ead;\">fn </span><span style=\"color:#8fa1b3;\">svg_handler</span><span>(</span><span style=\"color:#bf616a;\">req</span><span>: Request) -&gt; Res&lt;impl IntoResponse&gt; {\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> svg = </span><span style=\"color:#96b5b4;\">prepare_svg</span><span>(req.</span><span style=\"color:#96b5b4;\">uri</span><span>()).await?;\n</span><span>  Ok((StatusCode::</span><span style=\"color:#d08770;\">OK</span><span>, [(header::</span><span style=\"color:#d08770;\">CONTENT_TYPE</span><span>, &quot;</span><span style=\"color:#a3be8c;\">image/svg+xml</span><span>&quot;)], svg))\n</span><span>}\n</span><span>\n</span><span>async </span><span style=\"color:#b48ead;\">fn </span><span style=\"color:#8fa1b3;\">png_handler</span><span>(</span><span style=\"color:#bf616a;\">req</span><span>: Request) -&gt; Res&lt;impl IntoResponse&gt; {\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> svg = </span><span style=\"color:#96b5b4;\">prepare_svg</span><span>(req.</span><span style=\"color:#96b5b4;\">uri</span><span>()).await?;\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> png = </span><span style=\"color:#96b5b4;\">render_png</span><span>(&amp;svg);\n</span><span>  Ok((StatusCode::</span><span style=\"color:#d08770;\">OK</span><span>, [(header::</span><span style=\"color:#d08770;\">CONTENT_TYPE</span><span>, &quot;</span><span style=\"color:#a3be8c;\">image/png</span><span>&quot;)], png))\n</span><span>}\n</span></code></pre>\n<p>I run it, and generally, everything works, but the avatar doesn't show up.</p>\n<img src=\"/ogi-image-generator-1.png\" />\n<h2 id=\"loading-remote-images\"><a class=\"zola-anchor\" href=\"#loading-remote-images\" aria-label=\"Anchor link for: loading-remote-images\">Loading remote images</a></h2>\n<p><code>resvg</code> itself cannot load images from remote URLs used in SVG, but it can render images from a base64-encoded data string. Okay, I'll load the image and convert it myself:</p>\n<pre data-lang=\"rust\" style=\"background-color:#2b303b;color:#c0c5ce;\" class=\"language-rust \"><code class=\"language-rust\" data-lang=\"rust\"><span style=\"color:#b48ead;\">use </span><span>base64::Engine;\n</span><span style=\"color:#b48ead;\">use </span><span>reqwest::header::{HeaderMap, HeaderValue};\n</span><span>\n</span><span>async </span><span style=\"color:#b48ead;\">fn </span><span style=\"color:#8fa1b3;\">load_base64_image</span><span>(</span><span style=\"color:#bf616a;\">url</span><span>: &amp;</span><span style=\"color:#b48ead;\">str</span><span>) -&gt; Res&lt;String&gt; {\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> ua = format!(&quot;</span><span style=\"color:#d08770;\">{}</span><span style=\"color:#a3be8c;\">/</span><span style=\"color:#d08770;\">{}</span><span>&quot;, env!(&quot;</span><span style=\"color:#a3be8c;\">CARGO_PKG_NAME</span><span>&quot;), env!(&quot;</span><span style=\"color:#a3be8c;\">CARGO_PKG_VERSION</span><span>&quot;));\n</span><span>\n</span><span>  </span><span style=\"color:#b48ead;\">let mut</span><span> headers = HeaderMap::new();\n</span><span>  headers.</span><span style=\"color:#96b5b4;\">insert</span><span>(&quot;</span><span style=\"color:#a3be8c;\">User-Agent</span><span>&quot;, HeaderValue::from_str(&amp;ua)?);\n</span><span>\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> client = reqwest::Client::builder()\n</span><span>    .</span><span style=\"color:#96b5b4;\">default_headers</span><span>(headers)\n</span><span>    .</span><span style=\"color:#96b5b4;\">read_timeout</span><span>(std::time::Duration::from_secs(</span><span style=\"color:#d08770;\">10</span><span>))\n</span><span>    .</span><span style=\"color:#96b5b4;\">build</span><span>()?;\n</span><span>\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> rep = client.</span><span style=\"color:#96b5b4;\">get</span><span>(url).</span><span style=\"color:#96b5b4;\">send</span><span>().await?;\n</span><span>\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> max_size = </span><span style=\"color:#d08770;\">1024 </span><span>* </span><span style=\"color:#d08770;\">1024 </span><span>* </span><span style=\"color:#d08770;\">5</span><span>; </span><span style=\"color:#65737e;\">// 5MB\n</span><span>  </span><span style=\"color:#b48ead;\">match</span><span> rep.</span><span style=\"color:#96b5b4;\">content_length</span><span>() {\n</span><span>    None =&gt; </span><span style=\"color:#b48ead;\">return </span><span>AppError::new(&quot;</span><span style=\"color:#a3be8c;\">Image size is unknown</span><span>&quot;),\n</span><span>    Some(len) </span><span style=\"color:#b48ead;\">if</span><span> len &gt; max_size =&gt; </span><span style=\"color:#b48ead;\">return </span><span>AppError::new(&quot;</span><span style=\"color:#a3be8c;\">Image is too large</span><span>&quot;),\n</span><span>    _ =&gt; {}\n</span><span>  };\n</span><span>\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> allowed = [&quot;</span><span style=\"color:#a3be8c;\">image/jpeg</span><span>&quot;, &quot;</span><span style=\"color:#a3be8c;\">image/png</span><span>&quot;, &quot;</span><span style=\"color:#a3be8c;\">image/webp</span><span>&quot;, &quot;</span><span style=\"color:#a3be8c;\">image/svg+xml</span><span>&quot;];\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> mime = </span><span style=\"color:#b48ead;\">match</span><span> rep.</span><span style=\"color:#96b5b4;\">headers</span><span>().</span><span style=\"color:#96b5b4;\">get</span><span>(header::</span><span style=\"color:#d08770;\">CONTENT_TYPE</span><span>) {\n</span><span>    None =&gt; </span><span style=\"color:#b48ead;\">return </span><span>AppError::new(&quot;</span><span style=\"color:#a3be8c;\">Content type is unknown</span><span>&quot;),\n</span><span>    Some(ct) </span><span style=\"color:#b48ead;\">if </span><span>!allowed.</span><span style=\"color:#96b5b4;\">contains</span><span>(&amp;ct.</span><span style=\"color:#96b5b4;\">to_str</span><span>().</span><span style=\"color:#96b5b4;\">unwrap</span><span>()) =&gt; {\n</span><span>      </span><span style=\"color:#b48ead;\">return </span><span>AppError::new(&amp;format!(&quot;</span><span style=\"color:#a3be8c;\">Content type is not allowed: </span><span style=\"color:#d08770;\">{:?}</span><span>&quot;, ct))\n</span><span>    }\n</span><span>    Some(ct) =&gt; ct.</span><span style=\"color:#96b5b4;\">to_str</span><span>().</span><span style=\"color:#96b5b4;\">unwrap</span><span>().</span><span style=\"color:#96b5b4;\">to_string</span><span>(),\n</span><span>  };\n</span><span>\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> rep = rep.</span><span style=\"color:#96b5b4;\">bytes</span><span>().await?;\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> rep = base64::engine::general_purpose::</span><span style=\"color:#d08770;\">STANDARD</span><span>.</span><span style=\"color:#96b5b4;\">encode</span><span>(rep);\n</span><span>  Ok(format!(&quot;</span><span style=\"color:#a3be8c;\">data:</span><span style=\"color:#d08770;\">{mime}</span><span style=\"color:#a3be8c;\">;base64,</span><span style=\"color:#d08770;\">{rep}</span><span>&quot;))\n</span><span>}\n</span><span>\n</span><span>async </span><span style=\"color:#b48ead;\">fn </span><span style=\"color:#8fa1b3;\">prepare_svg</span><span>(</span><span style=\"color:#bf616a;\">uri</span><span>: &amp;axum::http::Uri) -&gt; Res&lt;String&gt; {\n</span><span>  </span><span style=\"color:#65737e;\">// ...\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> photo = qs.</span><span style=\"color:#96b5b4;\">get</span><span>(&quot;</span><span style=\"color:#a3be8c;\">photo</span><span>&quot;).</span><span style=\"color:#96b5b4;\">cloned</span><span>().</span><span style=\"color:#96b5b4;\">unwrap_or</span><span>(&quot;</span><span style=\"color:#a3be8c;\">https://gravatar.com/avatar/</span><span>&quot;.</span><span style=\"color:#96b5b4;\">to_string</span><span>());\n</span><span>  </span><span style=\"color:#b48ead;\">let</span><span> photo = </span><span style=\"color:#96b5b4;\">load_base64_image</span><span>(&amp;photo).await?;\n</span><span>  Ok(</span><span style=\"color:#96b5b4;\">render_svg</span><span>(&amp;title, &amp;author, &amp;url, &amp;photo).</span><span style=\"color:#96b5b4;\">into_string</span><span>())\n</span><span>}\n</span></code></pre>\n<p>I check generation again – everything is fine, the avatar is present in the final render:</p>\n<img src=\"/ogi-image-generator-2.png\" />\n<h2 id=\"docker-image\"><a class=\"zola-anchor\" href=\"#docker-image\" aria-label=\"Anchor link for: docker-image\">Docker image</a></h2>\n<p>So, the service is ready. Now, just needed to pack code into a <a href=\"/fast-multi-arch-docker-for-rust\">Docker image</a>. It's pretty much the same as usual, except that fonts files should be added to image too. I usually use Alpine images, and fonts can be added via <code>apk</code>:</p>\n<pre data-lang=\"Dockerfile\" style=\"background-color:#2b303b;color:#c0c5ce;\" class=\"language-Dockerfile \"><code class=\"language-Dockerfile\" data-lang=\"Dockerfile\"><span style=\"color:#b48ead;\">FROM</span><span> alpine:latest\n</span><span style=\"color:#b48ead;\">RUN </span><span>apk add --no-cache ttf-opensans\n</span><span style=\"color:#b48ead;\">WORKDIR </span><span>/app\n</span><span style=\"color:#65737e;\"># ... copy and run bin file\n</span></code></pre>\n<h2 id=\"fin\"><a class=\"zola-anchor\" href=\"#fin\" aria-label=\"Anchor link for: fin\">Fin</a></h2>\n<p>I added a template and copied themes from <code>sagarhani/og-image-generator</code>. I also created a preview page where you can experiment with the generation. This is enough for my current needs, but if anyone needs more, Issues/PRs are welcome.</p>\n<p>The service is available at: <a rel=\"noopener\" target=\"_blank\" href=\"https://ogp.fly.dev\">https://ogp.fly.dev</a><br />\nThe code is on GitHub: <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/vladkens/ogp\">https://github.com/vladkens/ogp</a></p>\n<p>The service is currently running without any restrictions. There is also the option to run self-hosted version with <code>ghcr.io/vladkens/ogp</code> image.</p>\n<p>To integrate this service into a static website, you just need to add corresponding <code>&lt;meta&gt;</code> tags with service link and replace token with your data.</p>\n<pre data-lang=\"html\" style=\"background-color:#2b303b;color:#c0c5ce;\" class=\"language-html \"><code class=\"language-html\" data-lang=\"html\"><span>&lt;</span><span style=\"color:#bf616a;\">meta\n</span><span>  </span><span style=\"color:#d08770;\">property</span><span>=&quot;</span><span style=\"color:#a3be8c;\">og:image</span><span>&quot;\n</span><span>  </span><span style=\"color:#d08770;\">content</span><span>=&quot;</span><span style=\"color:#a3be8c;\">https://ogp.fly.dev/v0/png?title={title}&amp;author={author}&amp;photo={photo}&amp;url={url}&amp;theme={theme}</span><span>&quot;\n</span><span>/&gt;\n</span></code></pre>\n<p>Usage example for this blog: <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/vladkens/blog/blob/ae18520/templates/base.html#L21\">link generation</a>, <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/vladkens/blog/blob/ae18520/templates/base.html#L44\">meta tags</a>. To see link sharing at work click on links below ⬇️💀</p>\n","flags":null,"enclosureUrl":"","enclosureMime":""}]}